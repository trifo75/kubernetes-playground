terraform {
  required_providers {
    incus = {
      source  = "lxc/incus"
      version = ">=0.1.0"
    }
  }
}

provider "incus" {
  # Uses your local incus socket
}

# --- Network ---
resource "incus_network" "kube_br0" {
  name = "kube_br0"

  config = {
    "ipv4.address" = "192.168.101.1/24"
    "ipv4.nat"     = "true"
    "ipv6.address" = "none"
  }
}

# --- Storage pool ---
resource "incus_storage_pool" "kubepool" {
  name   = "kubepool"
  driver = "dir"

}

# --- Profile ---
resource "incus_profile" "kubelab" {
  name = "kubelab"

  depends_on = [
     incus_network.kube_br0,
     incus_storage_pool.kubepool
  ]

  description = "Kubernetes lab node"

  device {
    name = "eth0"
    type = "nic"
    properties = {
      network = incus_network.kube_br0.name
      name    = "eth0"
    }
  }

  device {
    name = "root"
    type = "disk"
    properties = {
      pool = incus_storage_pool.kubepool.name
      path = "/"
    }
  }

  # device {
  #   name =   "kmsg"
  #   type =   "unix-char"
  #   properties = {
  #     path =   "/dev/kmsg"
  #     source = "/dev/kmsg"
  #   }
  # }

  config = {
    "limits.cpu" = "2"
    "limits.memory" = "3GB"
    # disable swap
    "limits.memory.swap" = "false"
    "boot.autostart" = "true"
  }

}

# #####################################
# config:
#   limits.cpu: "2"
#   limits.memory: 2GB
#   limits.memory.swap: "false"
#   linux.kernel_modules: ip_tables,ip6_tables,nf_nat,overlay,br_netfilter
#   raw.lxc: "lxc.apparmor.profile=unconfined\nlxc.cap.drop= \nlxc.cgroup.devices.allow=a\nlxc.mount.auto=proc:rw
#     sys:rw"
#   security.privileged: "true"
#   security.nesting: "true"
# description: LXD profile for Kubernetes
# devices:
#   eth0:
#     name: eth0
#     nictype: bridged
#     parent: lxdbr0
#     type: nic
#   kmsg:
#     path: /dev/kmsg
#     source: /dev/kmsg
#     type: unix-char
#   root:
#     path: /
#     pool: default
#     type: disk
# name: k8s
# used_by: []