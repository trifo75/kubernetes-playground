

Kubernetes upgrade

* drain master1

kubectl drain master1 --ignore-daemonsets

* stop kube-apiserver with SIGTERM
  (the process restarted without params)

* Add package repository for the new version if  reising minor version (1.33.x -> 1.34.y)

  /apt/sources.list.d/kubernetes.list -> add line
  deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /
  
  Key is the same (?)
  
* control plane - kubeadm upgrade
    First upgrade kubeadm itself to control upgrade process


    # choosing voluntarily not the latest one - to later test patch upgrade
    sudo apt-mark unhold kubeadm && \
    sudo apt-get update && sudo apt-get install -y kubeadm='1.34.1-1.1' && \
    sudo apt-mark hold kubeadm
    
* check if kubeadm upgrade is OK

   kubeadm version
   => should repor the target version

* run upgrade plan 

   Specify target version if the target is not the latest
   
   kubeadm upgrade plan v1.34.1

* run the upgrade

   # If needed, images can be pre-fetched with
   kubeadm config images pull
   
   kubeadm upgrade plan v1.34.1

* update kubelet and kubectl

    # replace x in 1.34.1-1.1 with the latest patch version
    sudo apt-mark unhold kubelet kubectl && \
    sudo apt-get update && sudo apt-get install -y kubelet='1.34.1-1.1' kubectl='1.34.1-1.1' && \
    sudo apt-mark hold kubelet kubectl

* restart kubelet

  systemctl daemon-reload
  systemctl restart kubelet

* uncordon drained node

    kubectl uncordon master1


########### Additional master nodes

* Stop APIserver


* Add package repository for the new version if  reising minor version (1.33.x -> 1.34.y)

  /apt/sources.list.d/kubernetes.list -> add line
  deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /

  apt update
  
* Install new kubeadm version
    First upgrade kubeadm itself to control upgrade process

    # choosing voluntarily not the latest one - to later test patch upgrade
    apt-mark unhold kubeadm && \
    apt-get update && sudo apt-get install -y kubeadm='1.34.1-1.1' && \
    apt-mark hold kubeadm

* check if kubeadm upgrade is OK

   kubeadm version
   => should repor the target version

* run upgrade

    "plan" is only needed the first master
    
    kubeadm upgrade node 
    
* drain node

    kubectl drain master2 --ignore-daemonsets

* update kubelet and kubectl

    # replace x in 1.34.1-1.1 with the latest patch version
    apt-mark unhold kubelet kubectl && \
    sudo apt-get install -y kubelet='1.34.1-1.1' kubectl='1.34.1-1.1' && \
    apt-mark hold kubelet kubectl

* restart kubelet

  systemctl daemon-reload
  systemctl restart kubelet

* uncordon drained node

    kubectl uncordon master2


################ Upgrade worker nodes

* like second master node, without stopping API server

################ Result:

 $ k get no -o wide
NAME      STATUS   ROLES           AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION       CONTAINER-RUNTIME
master1   Ready    control-plane   3d19h   v1.34.1   192.168.211.2   <none>        Ubuntu 22.04.5 LTS   5.15.0-161-generic   containerd://1.7.28
master2   Ready    control-plane   3d19h   v1.34.1   192.168.211.3   <none>        Ubuntu 22.04.5 LTS   5.15.0-161-generic   containerd://1.7.28
master3   Ready    control-plane   3d19h   v1.34.1   192.168.211.4   <none>        Ubuntu 22.04.5 LTS   5.15.0-161-generic   containerd://1.7.28
worker1   Ready    <none>          3d18h   v1.34.1   192.168.211.5   <none>        Ubuntu 22.04.5 LTS   5.15.0-161-generic   containerd://1.7.28
worker2   Ready    <none>          3d18h   v1.34.1   192.168.211.6   <none>        Ubuntu 22.04.5 LTS   5.15.0-161-generic   containerd://1.7.28
